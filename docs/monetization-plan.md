# План системы монетизации SongTalk AI (Speakeasy)

Наценка: **1,5×** к закупке у посредника. Платёжный шлюз (ЮKassa) подключается позже; сначала — учёт баланса, списаний и простое ручное пополнение для реальных аккаунтов.

---

## 1. Можно ли сначала сделать монетизацию, потом шлюз?

**Да.**

1. **Сейчас:** баланс пользователя (рубли), учёт использования, списание по тарифу 1,5×. Пополнение — **ручное начисление** на реальные аккаунты (без платёжного шлюза).
2. **Позже:** подключаем ЮKassa. Он только добавляет способ пополнения; логика «баланс → списание» уже работает.

---

## 2. Тарифы (наценка 1,5× + 6% налог в цене)

Базовая цена = закупка у посредника × 1,5. **Налог УСН 6% заложен в цену:** платит пользователь, мы из выручки платим налог; в интерфейсе про налог не сообщаем.

**Формула:** чтобы после уплаты 6% налога у нас осталась сумма X, пользователь платит **X / (1 − 0,06) = X / 0,94** (округление вверх до копеек). Итоговая цена для пользователя = (закупка × 1,5) / 0,94.

| Модель / сервис | Единица | Закупка (посредник) | Цена для пользователя (1,5× + 6% налог) |
|-----------------|---------|----------------------|------------------------------------------|
| deepseek-v3.2 (вход) | 1M токенов | 54,03 ₽ | **86,22 ₽** |
| deepseek-v3.2 (выход) | 1M токенов | 81,05 ₽ | **129,34 ₽** |
| gpt-4o-mini-tts | 1M символов | 2 895 ₽ | **4 620,74 ₽** |
| whisper-1 | 60 сек | 1,15 ₽ | **1,84 ₽** |

**Пример:** пользователь потратил по нашему тарифу 531 ₽ (из них ~30 ₽ — налог) → мы платим налог ~31 ₽, посреднику ~333 ₽ → наш заработок ~167 ₽ (как и без налога в цене).

**Ваша прибыль с пополнения (при наценке 1,5× и 6% налоге в цене):**

| Сумма на баланс | Пользователь платит (с налогом) | Налог 6% | Затраты посреднику | Ваша прибыль |
|-----------------|---------------------------------|----------|--------------------|--------------|
| 300 ₽ | **320 ₽** | 19,20 ₽ | 200 ₽ | **100 ₽** |
| 500 ₽ | **532 ₽** | 31,92 ₽ | 333,33 ₽ | **166,67 ₽** |
| 1 000 ₽ | **1 064 ₽** | 63,84 ₽ | 666,67 ₽ | **333,33 ₽** |

**Важно:** комиссия ЮKassa (0,7%) учитывается отдельно при пополнении через шлюз (см. п. 4). Тарифы выше — это списание с баланса; при пополнении к сумме к оплате добавляется ещё и налог (и при оплате картой — комиссия шлюза).

---

## 3. Как показывать ценность пользователю (конверсия в покупку)

Тарифы из п. 2 («за 1M токенов», «за 1M символов») **в интерфейсе не выставлять открыто**. Пользователю показываем не цены моделей, а **что он получит** за свои деньги — в понятных единицах, чтобы он ощущал выгоду.

**Идея (по аналогии с супермаркетом):** «Грибы за 100 ₽» — за 100 г; человек видит небольшую цифру, берёт, в итоге набирает килограмм. То есть показываем **цену за маленькую, понятную единицу** и формулируем в формате «что получишь», а не «сколько стоит одна техническая единица».

**Расчёт по тарифам п. 2 (с учётом 6% налога в цене) — консервативный:**

Для подписей в интерфейсе используем **завышенный** расход на минуту и на озвучку, чтобы пользователь в реальности чаще получал **больше** обещанного.

- **1 минута разговора с агентом (консервативно):** по тарифам с налогом ≈ **~2,34 ₽/мин.** (В лёгком сценарии меньше — пользователь получит больше минут.)
- **1 озвучка (консервативно):** фраза ~80 символов ≈ **~0,37 ₽.** (Короткие фразы дешевле.)

**Что показывать пользователю (округление вниз):**

| Сумма на баланс | Обещаем в подписи (не больше) | Реальность при среднем использовании |
|-----------------|------------------------------|--------------------------------------|
| 300 ₽ | ~2 часа с агентом или до 800 озвучек | часто 2,5–3 ч или 800+ озвучек |
| 500 ₽ | ~3,5 часа практики или до 1 300 озвучек | часто 4–5 ч или 1 300+ озвучек |
| 1 000 ₽ | ~7 часов разговора или до 2 500 озвучек | часто 8–10 ч или 2 500+ озвучек |

**Детальный расчёт: сколько пользователь получает (минуты, озвучки, токены) при нашей наценке 1,5× + 6%:**

Исходные тарифы для пользователя (п. 2): deepseek-v3.2 вход **86,22 ₽/1M токенов**, выход **129,34 ₽/1M токенов**; gpt-4o-mini-tts **4 620,74 ₽/1M символов**; whisper **1,84 ₽/60 сек**. Консервативные эквиваленты: **~2,34 ₽/мин** разговора с агентом, **~0,37 ₽** за одну озвучку (~80 символов).

| Сумма на баланс | Минуты с агентом (по 2,34 ₽/мин) | Озвучки по ~80 симв. (по 0,37 ₽) | Токены LLM (если тратить только на deepseek) |
|-----------------|-----------------------------------|-----------------------------------|---------------------------------------------|
| **300 ₽** | **≈128 мин** (~2 ч 08 мин); в подписи обещаем **не больше ~2 ч** | **≈810** озвучек; в подписи **до 800** | вход: **≈3,48M** токенов; выход: **≈2,32M** токенов; при условной смеси 50/50 по стоимости — **≈2,9M токенов** (вход+выход) |

| **500 ₽** | **≈214 мин** (~3 ч 34 мин); в подписи **~3,5 ч** | **≈1 351** озвучка; в подписи **до 1 300** | вход: **≈5,80M**; выход: **≈3,87M**; смесь — **≈4,8M токенов** |

| **1 000 ₽** | **≈427 мин** (~7 ч 07 мин); в подписи **~7 ч** | **≈2 703** озвучки; в подписи **до 2 500** | вход: **≈11,6M**; выход: **≈7,73M**; смесь — **≈9,6M токенов** |

Формулы: минуты = сумма / 2,34; озвучки = сумма / 0,37; входные токены = (сумма / 86,22) × 1 000 000; выходные токены = (сумма / 129,34) × 1 000 000. В интерфейсе показывать только «обещаем в подписи» (минуты/часы и озвучки), технические токены — не выставлять.

**Применение к пополнению баланса:**

- **Минимальное пополнение — 300 ₽.** (При оплате через шлюз и при выборе фиксированных кнопок — не предлагать суммы ниже.)
- **Не писать:** «81,05 ₽ за 1M токенов», «4 342 ₽ за 1M символов» — это холодно и пугает.
- **Писать и показывать:** только числа из колонки «Обещаем в подписи» — так мы не завышаем ожидания и не запятнаем репутацию.
- **Фиксированные кнопки пополнения** — подпись строго по консервативному расчёту:
  - «300 ₽» — «~2 часа с агентом» или «до 800 озвучек»
  - «500 ₽» — «~3,5 часа практики» или «до 1 300 озвучек»
  - «1 000 ₽» — «~7 часов разговора» или «до 2 500 озвучек»
- **В статистике использования** — расход в рублях за период без технических названий моделей; при желании нейтрально: «разговор с агентом», «озвучки», «словарь».

**Итог:** пользователь при обзоре видит **сколько он получит** (минуты, озвучки, занятия), а не голые цены на модели; ощущает выгоду от пополнения, конверсия в покупку выше.

---

## 4. Налог 6% и комиссия ЮKassa (0,7%) — в цене пополнения, пользователь о них не знает

- **Налог УСН 6%** и **комиссию ЮKassa 0,7%** не поглощаем. Итоговая сумма пополнения, которую видит пользователь, уже включает и то и другое; отдельными строками не показываем.
- **Формула пополнения через шлюз:** хотим зачислить на баланс **X ₽**. После уплаты налога 6% у нас должна остаться сумма, достаточная для зачисления X (т.е. на баланс мы зачисляем X). После комиссии ЮKassa мы получаем сумму A, после налога с A у нас остаётся X. Отсюда: A × (1 − 0,06) = X ⇒ A = X / 0,94; сумма к оплате P × (1 − 0,007) = A ⇒ **P = X / (0,94 × 0,993)** ≈ **X / 0,9334** (округление вверх до копеек). Эту сумму P показываем пользователю как «Пополнить на … ₽»; на баланс зачисляется ровно X ₽.
- **Без шлюза (ручное пополнение):** при начислении админом на баланс падает X; налог мы платим с общей выручки по отчётности, в момент пополнения ничего отдельно не считаем.
- Итог: пользователь видит **одну итоговую цену** (с налогом и комиссией), но не знает, что в неё входит налог и комиссия.

---

## 5. Авторизация: JWT без лишних запросов к БД

- Сейчас авторизация строится на **JWT**: бэкенд не обращается к БД на каждый запрос только ради проверки пользователя.
- В системе монетизации:
  - **Проверка пользователя** — по JWT (как сейчас).
  - **Баланс** — читать из БД только когда это нужно: перед/после платного действия (списание) и при запросах «баланс / история». То есть не на каждый запрос, а только на платные эндпоинты и эндпоинты баланса.
  - В JWT **не обязательно** хранить баланс (он меняется часто); достаточно при вызове платного API: проверить JWT → загрузить баланс → списать → ответ. Доп. один запрос к БД только на платные вызовы — приемлемо.
- Итог: зависимость от БД только там, где идёт работа с балансом; JWT по-прежнему основной источник идентификации пользователя.

---

## 6. Простое начисление на реальные аккаунты (пока нет шлюза)

Нужен **удобный способ начислять деньги на реальные аккаунты** без платёжного шлюза.

- **Кто делает начисление:** админ или доверенное лицо (по логину/роли или по отдельному секрету).
- **Как:**
  - Вариант **A:** Отдельный эндпоинт (защищённый): «начислить пользователю X ₽». Пользователь задаётся по `user_id` или **email** (поиск в БД). Сумма, комментарий (опционально). Запись в историю: тип «пополнение_ручное», кто начислил, когда.
  - Вариант **B:** Та же логика, но через простую **админ-страницу**: поле email (или выбор пользователя), сумма, кнопка «Начислить». Удобно для регулярного пополнения тестовых и ранних пользователей.
- **Обязательно:** каждая операция начисления пишется в историю (user_id, сумма, тип «пополнение_ручное», метаданные при необходимости), чтобы был аудит.

**Результат:** можно уверенно пополнять реальные аккаунты до появления ЮKassa.

---

## 7. Вкладка «Пополнение баланса» и статистика использования

Отдельная вкладка (или страница) **«Пополнение баланса»**, где пользователь видит баланс, способ пополнения и **статистику своего использования** (по аналогии с консолью посредника).

### 7.1 Блок «Баланс и пополнение»

- Текущий **баланс** (руб.).
- **Минимальное пополнение — 300 ₽.** В интерфейсе не предлагать и не принимать суммы меньше.
- Кнопки пополнения с **ощущением выгоды** (п. 3): фиксированные суммы + подпись по консервативному расчёту, например «300 ₽ — ~2 часа с агентом», «500 ₽ — ~3,5 часа практики», «1 000 ₽ — ~7 часов разговора». Пока шлюза нет — заглушка «Скоро»; после ЮKassa — переход к оплате по выбранной сумме.
- При ручном пополнении админом пользователь видит в истории операций запись «Пополнение (ручное)».

### 7.2 Период для статистики

- Переключатель периода: **Сегодня** | **7 дней** | **30 дней** | **90 дней** (как в примере консоли).

### 7.3 Сводка за период

- **Сумма расходов за период** (руб.) — сколько списано с баланса за выбранный период.
- **Количество запросов** за период (все платные вызовы: chat, tts, stt, define и т.д.).
- **Среднее в день** (руб.) — сумма расходов / число дней в периоде.
- **Среднее за запрос** (руб.) — сумма расходов / количество запросов.

Пример отображения (по аналогии с консолью):

```text
За 30 дней
160.53 руб.
1 221 запросов

Среднее в день    5.35 руб.
Среднее за запрос 0.1315 руб.
```

### 7.4 Топы по использованию

- **Топ по тратам (руб.):** по моделям/сервисам — например «gpt-4o-mini-tts — 98.13 руб.», «deepseek-v3.2 — 45.20 руб.» и т.д.
- **Топ по запросам:** по моделям/сервисам — например «deepseek-v3.2 — 652 запросов», «whisper-1 — 200 запросов» и т.д.

Данные считаются по истории списаний за выбранный период (по полям «сервис/модель», сумма, количество запросов).

### 7.5 Расходы по моделям (опционально)

- Блок «По моделям»: разбивка расходов по моделям за период (таблица или простой список: модель → сумма руб.).

### 7.6 История расходов

- Таблица **«История расходов»** с колонками:
  - **Модель** (или сервис) — например `gpt-4o-mini-tts`, `deepseek-v3.2`, `whisper-1`.
  - **Дата** — дата и время операции (как в консоли: «15.02.2026, 23:24»).
  - **Сумма (руб.)** — списание за этот запрос.

- Фильтры (опционально): по модели, по методу (если будет разделение).
- Пагинация или «подгрузить ещё» для длинной истории.

### 7.7 Экспорт

- Кнопка **«Скачать CSV»**: выгрузка истории расходов за выбранный период в формате, аналогичном консоли (Модель, Дата, Цена/Сумма).

---

## 8. Этапы реализации (обновлённые)

### Этап 1. Данные и модель

- **1.1** Таблица **баланса пользователя**: `user_id`, баланс (decimal/float, рубли), `updated_at`.
- **1.2** Таблица **истории операций**: `user_id`, сумма (+/−), тип операции (списание_за_использование, пополнение_ручное, пополнение_шлюз), `service`/`model` (для списаний), привязка к запросу (опционально: `request_id`, `usage_units`), `created_at`. Достаточно полей, чтобы считать статистику по периодам и по моделям.
- **1.3** Справочник **тарифов** (ставки с наценкой 1,5×): модель/сервис, единица, цена за единицу. Хранить в конфиге или БД.

**Результат:** есть куда писать баланс и историю; тарифы зафиксированы.

---

### Этап 2. Учёт использования и списание (с учётом JWT)

- **2.1** На каждом платном вызове (agent chat, agent/tts, agent/stt, /api/tts, /api/transcribe, словарь define и т.д.):
  - идентификация по **JWT** (без лишних запросов к БД для «кто такой»);
  - загрузка баланса из БД;
  - выполнение запроса к посреднику, получение **usage** (input_tokens, output_tokens, символы TTS, секунды Whisper);
  - расчёт стоимости по нашим ставкам (1,5×);
  - списание с баланса, запись в историю (user_id, −сумма, service/model, дата).
- **2.2** Перед платным запросом: если баланс &lt; порога (0 или 10 ₽) — ответ 402 / «Пополните баланс».
- **2.3** Эндпоинты:
  - **GET** баланс текущего пользователя (по JWT);
  - **GET** история операций (последние N, с фильтром по типу/периоду при необходимости).

**Результат:** платные действия списываются по тарифу 1,5×; JWT используется для авторизации, БД — только для баланса и истории.

---

### Этап 3. Ручное начисление на реальные аккаунты

- **3.1** Защищённый эндпоинт или админ-действие: начислить пользователю X ₽. Пользователь — по `user_id` или **email**. Запись в историю: тип «пополнение_ручное», сумма, кто/когда (если есть админ).
- **3.2** (Рекомендуется) Простая форма/страница: ввод email (или выбор пользователя), сумма, кнопка «Начислить» — для удобного пополнения реальных аккаунтов без шлюза.

**Результат:** можно пополнять реальные аккаунты вручную; аудит через историю операций.

---

### Этап 4. Вкладка «Пополнение баланса» и статистика

- **4.1** Вкладка (или страница) **«Пополнение баланса»** в интерфейсе приложения.
- **4.2** Блок баланса и кнопка «Пополнить» (заглушка до ЮKassa).
- **4.3** Переключатель периода: Сегодня / 7 / 30 / 90 дней.
- **4.4** Сводка за период: сумма расходов (руб.), количество запросов, среднее в день, среднее за запрос.
- **4.5** Топ по тратам (по моделям), топ по запросам (по моделям).
- **4.6** История расходов: таблица (Модель, Дата, Сумма руб.); при необходимости — фильтр по модели.
- **4.7** Кнопка «Скачать CSV» — выгрузка истории за выбранный период.

**Результат:** пользователь видит свой баланс, расходы и историю в одном месте, как в консоли посредника.

---

### Этап 5. Платёжный шлюз ЮKassa (позже)

- **5.1** В UI показываем итоговую цену пополнения (с налогом 6% и комиссией 0,7%, п. 4): сумма к оплате P = X / (0,94 × 0,993), на баланс зачисляется X ₽. О налоге и комиссии пользователю не сообщаем.
- **5.2** Эндпоинт создания платежа: сумма к зачислению (X), user_id из JWT, return_url, cancel_url; считаем сумму к оплате, редирект на ЮKassa.
- **5.3** Webhook/callback при успешной оплате: начисление X на баланс, запись в историю (тип «пополнение_шлюз», `payment_id`).
- **5.4** Идемпотентность по `payment_id`, обработка ошибок.

**Результат:** пополнение баланса картой через ЮKassa; комиссию покрывает пользователь, без упоминания в интерфейсе.

---

### Этап 6. Доработки UI (по необходимости)

- Отображение баланса в шапке/сайдбаре.
- Предупреждение «низкий баланс» при &lt; N ₽.
- Страница с тарифами («1M токенов — X ₽» и т.д.).

---

## 9. Порядок работ (кратко)

| Этап | Содержание | Зависимости |
|------|------------|-------------|
| 1 | Данные: баланс, история, тарифы | — |
| 2 | Списание за использование, проверка баланса (JWT + БД только для баланса), API баланса/истории | 1 |
| 3 | Ручное начисление на реальные аккаунты (эндпоинт + удобная форма/страница) | 1 |
| 4 | Вкладка «Пополнение баланса» + статистика использования (период, сводка, топы, история, CSV) | 2, 3 |
| 5 | ЮKassa (0,7% комиссия) | 1–4 |
| 6 | UI: баланс в шапке, предупреждения, тарифы | 2–4 |

---

## 10. План для разработчика (что за чем делать)

Ниже — последовательность для реализации. Каждый этап опирается на предыдущие; параллелить можно только то, что в одной группе.

### Шаг 1. Бэкенд + БД: данные под монетизацию

**Сделать первым.** Без этого нельзя ни списывать, ни показывать баланс.

1. **Миграция БД (Supabase):**
   - Таблица `user_balances`: `user_id` (uuid, PK, ref на auth.users), `balance_rub` (numeric), `updated_at`.
   - Таблица `balance_transactions`: `id` (uuid, PK), `user_id`, `amount_rub` (numeric, может быть отрицательным), `type` (enum: `usage`, `topup_manual`, `topup_gateway`), `service` (text, nullable — для списаний: модель/сервис), `metadata` (jsonb, опционально: request_id, usage_units), `created_at`.
   - При создании баланса при первом обращении — инициализировать 0 или не создавать запись до первого пополнения (решить: либо триггер при регистрации, либо «ленивое» создание при первом списании/пополнении).

2. **Тарифы в коде (конфиг или константы):**  
   Ставки для пользователя: 1,5× закупки и **делим на 0,94** (6% налог в цене). Итоговые значения см. в п. 2 плана (86,22 / 129,34 / 4 619,68 / 1,84 за соответствующие единицы). Функция: `getCost(service, usage) → rub`.

3. **Хелперы:**  
   Получить/обновить баланс пользователя, записать транзакцию. Всё в транзакции при списании (проверка баланса → списание → запись в `balance_transactions`).

**Готовность:** есть куда писать баланс и историю; тарифы считаются в коде.

**Промт для реализации:**

Реализуй шаг 1 монетизации по docs/monetization-plan.md. В Supabase: миграция с таблицами user_balances и balance_transactions (см. план). В бэкенде: конфиг тарифов с наценкой 1,5× и 6% налогом в цене — итоговые ставки: deepseek-v3.2 in 86,22 / out 129,34 ₽ за 1M токенов, gpt-4o-mini-tts 4 620,74 ₽ за 1M символов, whisper-1 1,84 ₽ за 60 сек; функция getCost(service, usage) → рубли; хелперы баланса и транзакций; при списании — проверка баланса и запись в одной транзакции. Баланс создавать «лениво» при первом пополнении или списании.

---

### Шаг 2. Бэкенд: списание при платных запросах

**После шага 1.** Подключаем списание к существующим платным эндпоинтам.

1. **Список платных эндпоинтов:**  
   `/api/agent/chat`, `/api/agent/tts`, `/api/agent/stt`, `/api/tts`, `/api/transcribe`, `/api/vocabulary/define` (и остальные, где вызывается посредник по п. 2 плана).

2. **Общая схема для каждого:**
   - По JWT получить `user_id`.
   - До вызова посредника: прочитать баланс; если баланс &lt; порога (например 0 или 10 ₽) → 402 + «Пополните баланс», не вызывать API.
   - Вызвать API посредника, из ответа взять usage (input_tokens, output_tokens, characters, duration — что отдаёт провайдер).
   - Посчитать стоимость: `getCost(service, usage)`.
   - В одной транзакции: уменьшить баланс, вставить запись в `balance_transactions` (type `usage`, service = модель).

3. **Эндпоинты для фронта:**
   - `GET /api/balance` — баланс текущего пользователя (по JWT). Возврат: `{ balance_rub }`.
   - `GET /api/balance/transactions` — история (последние N, опционально тип, период). Возврат: массив записей.

**Готовность:** пользователь тратит баланс при каждом платном действии; фронт может запрашивать баланс и историю.

**Промт для реализации:**

Реализуй шаг 2 монетизации по docs/monetization-plan.md. На платных эндпоинтах (api/agent/chat, api/agent/tts, api/agent/stt, api/tts, api/transcribe, api/vocabulary/define и др.): по JWT взять user_id; до вызова API посредника проверить баланс, при балансе < порога (0 или 10 ₽) вернуть 402 и «Пополните баланс»; после ответа посредника взять usage (input_tokens, output_tokens, characters, duration), посчитать getCost(service, usage), в одной транзакции списать с баланса и записать в balance_transactions (type usage, service = модель). Добавить GET /api/balance (по JWT → balance_rub) и GET /api/balance/transactions (последние N, фильтр по типу и периоду). Использовать существующие хелперы баланса и тарифы из шага 1.

---

### Шаг 3. Бэкенд: ручное пополнение (без шлюза)

**После шага 1.** Можно делать параллельно с шагом 2.

1. Эндпоинт (только для админа/сервиса): `POST /api/admin/balance/topup` или аналог. Тело: `{ user_id или email, amount_rub, comment? }`. Проверка прав (секрет, роль, JWT админа). Увеличить баланс, записать транзакцию с type `topup_manual`.

2. (Опционально) Простая админ-страница: форма (email, сумма, кнопка), вызов этого эндпоинта.

**Готовность:** реальные аккаунты можно пополнять вручную до подключения ЮKassa.

**Промт для реализации:**

Реализуй шаг 3 монетизации по docs/monetization-plan.md. Добавь защищённый эндпоинт POST /api/admin/balance/topup (или аналог): тело { user_id или email, amount_rub, comment? }; проверка прав (админ-ключ, роль или JWT); по user_id/email найти пользователя; увеличить balance_rub, записать в balance_transactions с type topup_manual. Опционально: простая админ-страница с формой (email, сумма, кнопка «Начислить»), вызывающая этот эндпоинт.

---

### Шаг 4. Фронт: вкладка «Пополнение баланса» и статистика

**После шагов 2 и 3.** Пользователь должен видеть баланс и историю; пополнение пока заглушка.

1. **Добавить вкладку/страницу** «Пополнение баланса» (в сайдбар/навигация по проекту).

2. **Блок баланса и пополнения (п. 7.1):**
   - Показать текущий баланс (запрос к `GET /api/balance`).
   - Кнопки: 300 ₽, 500 ₽, 1 000 ₽ с подписями по п. 3 (консервативные). Пока — заглушка «Скоро» или неактивные; минимальное пополнение 300 ₽ — в UI не предлагать меньше.

3. **Статистика за период (п. 7.2–7.4):**
   - Запрос к `GET /api/balance/transactions` с фильтром по периоду (сегодня, 7, 30, 90 дней) и типу (только `usage`).
   - На фронте посчитать: сумма расходов, количество запросов, среднее в день, среднее за запрос.
   - Топ по тратам и топ по запросам — группировка по полю `service`.

4. **История расходов (п. 7.6):** таблица по тем же транзакциям (модель/сервис, дата, сумма).

5. **Экспорт CSV (п. 7.7):** по выбранному периоду сформировать и скачать CSV.

**Готовность:** пользователь видит баланс, статистику и историю; пополнение — заглушка.

**Промт для реализации:**

Реализуй шаг 4 монетизации по docs/monetization-plan.md. Добавь вкладку/страницу «Пополнение баланса» (в сайдбар/навигацию). Блок баланса: запрос GET /api/balance, отображение баланса в рублях; кнопки 300 ₽, 500 ₽, 1 000 ₽ с подписями по плану (300 — «~2 часа с агентом», 500 — «~3,5 часа практики», 1 000 — «~7 часов разговора»), пока заглушка «Скоро»; минимум 300 ₽. Статистика: переключатель периода (сегодня, 7, 30, 90 дней), запрос GET /api/balance/transactions с фильтром (только usage); на фронте посчитать сумму расходов, число запросов, среднее в день, среднее за запрос; топ по тратам и топ по запросам по полю service. Таблица истории расходов (модель/сервис, дата, сумма). Кнопка «Скачать CSV» — выгрузка истории за выбранный период. Стиль и структура — в духе существующего приложения (dashboard, sidebar).

---

### Шаг 5. Бэкенд + фронт: платёжный шлюз ЮKassa

**После шагов 1–4.** Подключать только когда готовы шаги 1–4.

1. **Бэкенд:** эндпоинт создания платежа. Вход: сумма к зачислению X (300 / 500 / 1 000, мин. 300). Сумма к оплате = **X / (0,94 × 0,993)** (налог 6% + комиссия 0,7%), округление вверх. Создать платёж в ЮKassa (return_url, cancel_url, метаданные: user_id, amount X). Вернуть ссылку на оплату или redirect.

2. **Бэкенд:** webhook/callback ЮKassa при успешной оплате. По `payment_id` проверить идемпотентность (не начислять дважды). Зачислить X на баланс пользователя, записать транзакцию type `topup_gateway`, привязать `payment_id`.

3. **Фронт:** кнопки пополнения ведут на создание платежа (вызов API → редирект на ЮKassa). После возврата на return_url — показать «Баланс пополнен» и обновить баланс.

**Готовность:** пользователь может пополнять баланс картой; комиссия 0,7% заложена в цену, в UI не показывается.

**Промт для реализации:**

Реализуй шаг 5 монетизации по docs/monetization-plan.md. Бэкенд: эндпоинт создания платежа (вход — сумма к зачислению X, мин. 300; сумма к оплате P = X / (0.94 * 0.993) с округлением вверх — налог 6% и комиссия 0,7%; создать платёж в ЮKassa, вернуть ссылку). Webhook при успешной оплате: идемпотентность по payment_id; зачислить X на баланс, записать транзакцию type topup_gateway. Фронт: кнопки пополнения ведут на создание платежа и редирект на ЮKassa; return_url — «Баланс пополнен», обновить баланс. Налог и комиссию в UI не показывать.

---

### Шаг 6. Доработки UI (по необходимости)

**После шагов 2 и 4.** По приоритету.

- Показывать баланс в шапке или сайдбаре (запрос к `GET /api/balance` при загрузке/после пополнения).
- Предупреждение «низкий баланс» при балансе &lt; N ₽ (например 50).
- (Опционально) Отдельная страница с тарифами в человеко-понятном виде (без технических «1M токенов»), по п. 3.

**Промт для реализации:**

Реализуй шаг 6 монетизации по docs/monetization-plan.md. Показывать баланс в шапке или сайдбаре (запрос GET /api/balance при загрузке и после пополнения). При балансе < N ₽ (например 50) показывать предупреждение «низкий баланс» или призыв пополнить. Опционально: страница с тарифами в понятном виде для пользователя (что получишь за 300/500/1000 ₽), без технических единиц вроде «1M токенов» — по п. 3 плана.

---

### Порядок «что за чем» (сводка для разработчика)

```
1. БД + тарифы + хелперы баланса/транзакций
        ↓
2. Списание на платных эндпоинтах + GET /api/balance, GET /api/balance/transactions
3. Ручное пополнение (админ-эндпоинт, при необходимости админ-страница)
        ↓
4. Фронт: вкладка «Пополнение баланса» (баланс, кнопки с подписями, статистика, история, CSV)
        ↓
5. ЮKassa: создание платежа + webhook, фронт — редирект и обновление баланса
        ↓
6. UI: баланс в шапке, предупреждение о низком балансе (и при необходимости страница тарифов)
```

Параллельно после шага 1 можно вести **2** и **3**; **4** — только после **2** (и желательно **3**). **5** — после **4**. **6** — в любой момент после **2** и **4**.

---

## 11. Уточнения и краевые случаи (что учесть при реализации)

Ниже — моменты, которые в плане не расписаны пошагово; их нужно зафиксировать при разработке.

- **Налог 6% (УСН):** Все тарифы в п. 2 и сумма к оплате при пополнении уже включают 6% налога (пользователь платит, мы из выручки платим налог). В коде: ставки для списания и формула суммы пополнения — по плану; отдельно «налог» в UI не показываем.
- **Баланс и «дорогой» запрос:** Проверка баланса делается *до* вызова API посредника (порог 0 или 10 ₽). Фактическая стоимость известна *после* ответа. Если она окажется больше текущего баланса, возможны варианты: (1) не допускать отрицательный баланс — перед вызовом проверять баланс на «достаточность» по оценке (например, лимит токенов для чата) и при недостатке возвращать 402; (2) разрешить уход в небольшой минус с последующей блокировкой до пополнения. Рекомендация: порог перед запросом **10 ₽**, чтобы снизить риск ухода в минус; при реализации — явно решить, допускается ли отрицательный баланс.
- **Один платный запрос — одна или несколько записей в историю:** Для «топа по моделям» и разбивки по сервисам удобно писать **несколько строк** в `balance_transactions` за один вызов (например, agent chat → три строки: whisper, deepseek, tts с соответствующими суммами). Альтернатива — одна строка с общей суммой и `service = "agent_chat"`; тогда в статистике будет одна группа. При реализации выбрать один подход и придерживаться его.
- **Админ-доступ для ручного пополнения:** Секрет или ключ для `POST /api/admin/balance/topup` хранить в переменной окружения (например `ADMIN_BALANCE_SECRET`), не в коде. В запросе передавать заголовок `Authorization: Bearer <secret>` или отдельный заголовок `X-Admin-Key`.
- **Идемпотентность webhook ЮKassa:** При обработке успешной оплаты проверять по `payment_id`, не обрабатывали ли мы этот платёж уже (например, запись в `balance_transactions` с `metadata->>'payment_id' = id` или отдельная таблица обработанных `payment_id`). При повторной доставке webhook возвращать 200 и не начислять повторно.
- **Список платных эндпоинтов:** Помимо перечисленных в плане (agent/chat, agent/tts, agent/stt, /api/tts, /api/transcribe, vocabulary/define) проверить все маршруты, где вызывается посредник (в т.ч. vocabulary/idioms/analyze, vocabulary/phrasal-verbs/analyze и т.п.), и везде подключить проверку баланса и списание.
- **Округление стоимости:** Результат `getCost(...)` округлять до копеек (2 знака после запятой); при списании использовать один и тот же способ (например, округление вверх), чтобы не накапливать ошибки.

---

## 12. Что не делаем на первом шаге

- Подписки с лимитами — только баланс и списание по факту.
- Несколько валют — только рубли.
- Реферальные/промо-балансы — при необходимости ввести отдельным типом операции позже.

---

## 13. Разрешение на код

Код пишется **только после явного разрешения** по каждому этапу (или по документу в целом). Сейчас зафиксирован только план в этом MD-файле.
