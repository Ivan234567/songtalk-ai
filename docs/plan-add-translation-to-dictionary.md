# План: Добавление перевода в словарь одной кнопкой

## Цель
Добавить функциональность быстрого добавления переведенных слов из переводчика в словарь пользователя одной кнопкой.

## Анализ текущей реализации

### Переводчик (TranslatorPanel.tsx)
- **Состояние:**
  - `input` - исходный текст
  - `output` - переведенный текст
  - `direction` - направление перевода (`en-ru` | `ru-en`)
  - `token` - токен авторизации
  - `userId` - ID пользователя
  - `getApiUrl()` - функция получения URL API

### API добавления в словарь (`/api/vocabulary/add`)
- **Эндпоинт:** `POST /api/vocabulary/add`
- **Требования:**
  - Bearer токен авторизации
  - Параметры: `word` (обязательно), `video_id` (опционально), `context` (опционально)
- **Логика:**
  - Нормализует слово через `normalizeWord()`
  - Получает определение слова (AI только если нет в кэше)
  - Проверяет существование слова в словаре пользователя
  - Если существует - обновляет контексты
  - Если нет - создает новую запись
  - Создает/обновляет прогресс в `vocabulary_progress`

### Структура данных словаря
- **Таблица:** `user_vocabulary`
- **Поля:**
  - `word` - нормализованное слово (lowercase)
  - `translations` - JSONB массив переводов
  - `contexts` - JSONB массив контекстов
  - `difficulty_level` - уровень сложности (A1-C2)
  - `part_of_speech` - часть речи
  - `mastery_level` - уровень освоения (1-5)

## План реализации

### 1. Определение логики добавления

#### 1.1. Какие слова добавлять?
- **Если `direction === 'en-ru'`:** Добавляем слова из `input` (английский текст)
- **Если `direction === 'ru-en'`:** Добавляем слова из `output` (переведенный английский текст)

**Обоснование:** Словарь предназначен для изучения английских слов, поэтому всегда добавляем английские слова.

#### 1.2. Извлечение слов из текста
Создать функцию на фронтенде для извлечения слов:
```typescript
function extractWordsFromText(text: string): string[] {
  // 1. Разбить текст на слова через regex /\b[\w']+\b/g
  // 2. Нормализовать каждое слово (toLowerCase, trim, удалить пунктуацию)
  // 3. Фильтровать:
  //    - Пустые слова
  //    - Слова короче 2 символов
  //    - Стоп-слова (a, an, the, and, or, but, in, on, at, to, for, of, with, by, is, are, was, were, be, been, being, have, has, had, do, does, did, will, would, could, should, may, might, must, can, i, you, he, she, it, we, they, this, that, these, those, me, him, her, us, them)
  // 4. Вернуть уникальные слова (Set)
}
```

### 2. Валидация перед добавлением

Проверки:
1. ✅ Пользователь авторизован (`token` и `userId` не null)
2. ✅ Есть исходный текст (`input.trim().length > 0`)
3. ✅ Есть переведенный текст (`output.trim().length > 0`)
4. ✅ После извлечения и фильтрации есть хотя бы одно слово для добавления

### 3. UI/UX компонента

#### 3.1. Кнопка "Добавить в словарь"
- **Расположение:** Рядом с полем результата перевода (`output`), после текстового поля
- **Состояния:**
  - **Disabled:** Когда нет `output` или нет валидных слов для добавления
  - **Loading:** Во время процесса добавления
  - **Success:** После успешного добавления (временно показать иконку галочки)
- **Стиль:** Соответствует дизайну переводчика (фиолетовая тема)

#### 3.2. Индикация процесса
- Показать количество найденных слов: "Найдено X слов"
- Показать прогресс: "Добавлено X из Y слов"
- Показать уведомление об успехе: "Добавлено X слов в словарь"
- Показать ошибки, если они возникли

### 4. Реализация функции добавления

#### 4.1. Функция `addTranslationToDictionary`
```typescript
async function addTranslationToDictionary() {
  // 1. Валидация
  if (!token || !userId || !input.trim() || !output.trim()) {
    setError('Необходимо выполнить перевод перед добавлением в словарь');
    return;
  }

  // 2. Определить текст для извлечения слов
  const textToExtract = direction === 'en-ru' ? input : output;
  
  // 3. Извлечь слова
  const words = extractWordsFromText(textToExtract);
  
  if (words.length === 0) {
    setError('Не найдено слов для добавления');
    return;
  }

  // 4. Установить состояние загрузки
  setAddingToDictionary(true);
  setDictionaryError(null);
  setDictionarySuccess(null);

  // 5. Добавить каждое слово через API
  let addedCount = 0;
  let failedCount = 0;
  const errors: string[] = [];

  for (const word of words) {
    try {
      const response = await fetch(`${getApiUrl()}/api/vocabulary/add`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          word: word,
          context: textToExtract, // Используем исходный текст как контекст
        }),
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `Ошибка ${response.status}`);
      }

      addedCount++;
    } catch (err) {
      failedCount++;
      errors.push(`${word}: ${err instanceof Error ? err.message : 'Неизвестная ошибка'}`);
    }
  }

  // 6. Обновить состояние
  setAddingToDictionary(false);
  
  if (addedCount > 0) {
    setDictionarySuccess(`Добавлено ${addedCount} ${addedCount === 1 ? 'слово' : addedCount < 5 ? 'слова' : 'слов'} в словарь`);
  }
  
  if (failedCount > 0) {
    setDictionaryError(`Не удалось добавить ${failedCount} ${failedCount === 1 ? 'слово' : failedCount < 5 ? 'слова' : 'слов'}`);
  }
}
```

#### 4.2. Состояния компонента
Добавить новые состояния:
```typescript
const [addingToDictionary, setAddingToDictionary] = useState(false);
const [dictionaryError, setDictionaryError] = useState<string | null>(null);
const [dictionarySuccess, setDictionarySuccess] = useState<string | null>(null);
```

### 5. Обработка ошибок

#### 5.1. Типы ошибок
1. **Ошибка авторизации (401):** "Необходимо войти в систему"
2. **Ошибка сети:** "Ошибка соединения. Попробуйте позже"
3. **Ошибка валидации (400):** Показать сообщение от API
4. **Ошибка сервера (500):** "Ошибка сервера. Попробуйте позже"
5. **Частичный успех:** Показать количество успешно добавленных и не добавленных слов

#### 5.2. Логирование
- Логировать ошибки в консоль для отладки
- Не показывать технические детали пользователю

### 6. Оптимизации (опционально)

#### 6.1. Батч-добавление
Если API поддерживает батч-добавление, можно добавить несколько слов одним запросом.

#### 6.2. Дедупликация
Проверять, какие слова уже есть в словаре пользователя перед добавлением (через отдельный API или кэш).

#### 6.3. Показ предпросмотра
Перед добавлением показать модальное окно со списком слов, которые будут добавлены, с возможностью исключить некоторые.

### 7. Тестирование

#### 7.1. Тестовые сценарии
1. ✅ Добавление перевода `en-ru` с несколькими словами
2. ✅ Добавление перевода `ru-en` с несколькими словами
3. ✅ Добавление перевода с одним словом
4. ✅ Добавление перевода с пустым результатом (должно быть disabled)
5. ✅ Добавление перевода без авторизации (должна быть ошибка)
6. ✅ Добавление перевода с ошибкой сети
7. ✅ Добавление перевода, где некоторые слова уже есть в словаре (должны обновиться)
8. ✅ Добавление перевода с текстом, содержащим только стоп-слова (должно быть disabled)

### 8. Файлы для изменения

1. **`frontend/components/TranslatorPanel.tsx`**
   - Добавить функцию `extractWordsFromText`
   - Добавить функцию `addTranslationToDictionary`
   - Добавить состояния для добавления в словарь
   - Добавить UI кнопки и индикаторов

### 9. Последовательность реализации

1. ✅ Создать функцию `extractWordsFromText` для извлечения слов
2. ✅ Добавить состояния для управления процессом добавления
3. ✅ Реализовать функцию `addTranslationToDictionary`
4. ✅ Добавить кнопку "Добавить в словарь" в UI
5. ✅ Добавить индикаторы загрузки и результатов
6. ✅ Добавить обработку ошибок
7. ✅ Протестировать различные сценарии

## Примеры использования

### Пример 1: Перевод EN → RU
- **Input:** "Hello world, how are you?"
- **Output:** "Привет мир, как дела?"
- **Добавляются слова:** ["hello", "world", "how", "are", "you"] → после фильтрации: ["hello", "world"] (are, you - стоп-слова)

### Пример 2: Перевод RU → EN
- **Input:** "Привет, как дела?"
- **Output:** "Hello, how are you?"
- **Добавляются слова:** Из output → ["hello", "how", "are", "you"] → после фильтрации: ["hello"] (how, are, you - стоп-слова)

## Примечания

- Функция должна быть асинхронной и не блокировать UI
- При добавлении большого количества слов может потребоваться время
- Рекомендуется показывать прогресс для больших списков слов
- Можно добавить возможность отмены операции добавления
